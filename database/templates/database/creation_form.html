{% extends "database/base.html" %}
{% load static %}

{% block content %}

<head>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'autocomplete_light/vendor/select2/dist/css/select2.min.css' %}">
    <script src="{% static 'autocomplete_light/vendor/select2/dist/js/select2.full.min.js' %}"></script>
    <script src="{% static 'autocomplete_light/addanother.js' %}"></script>
</head>
{{ form.media }}

<form method="post">
    {% csrf_token %}
    <h2> Create a Musical Work </h2>
    <br>
    <h3> Title </h3>
    <div id='work_form'>
    <p>
        What is the title of the work? 
        Click the green button to add variant titles or nicknames.
        Please include opus number or catalogue numbers if applicable (e.g., 
        Op. 55, D960, BWV 202)
    </p>
        {{ form.title.label_tag }}
        {{ form.title }}
        <div class="multiple-entry"> 
            {{ form.variant_titles.label_tag }}
            {{ form.variant_titles }}
        </div>
        <div class="multiple-entry"> 
            {{ form.sections.label_tag }}
            {{ form.sections }}
        </div>
    <br>
    <h3> Contributions </h3>
    {{ contribution_form.management_form }}
        <div id="form_set">
            <p>
                Who created the work? 
                Use the drop-down menu to choose between different kinds of 
                contributions. Add more contributors with the green 
                button. 
            </p>
            {% for form in contribution_form %}
                {{ form.as_p }}
            {% endfor %}
            <div id="empty_form" style="display: none;">
                <div class="contributor-form">
                    <button class="btn btn-danger btn-sm delete-form">-</button>
                    {{ contribution_form.empty_form.as_p }}
                </div>
            </div>
        </div>
    <input input class="btn btn-success btn-sm" type="button" id="add_more" value="+">
    <br><br>
    <h3> Genre(s) </h3>
        <p>
            What type of piece is this? (e.g., song, symphony, motet)
        </p>
        <div id="genre_type_autocomplete_add">
            {{ form.genre_as_in_type }}
            <div id="add-type">
                <input type="text" id="add-type-input" />
                <button class="btn btn-primary" id="add-type-button" >Add New Type</button>
            </div>
        </div>
        <p>
            What style is this piece? (e.g., classical, jazz)
        </p>
        {{ form.genre_as_in_style }}

        {{ form.sacred_or_secular.label_tag }}
        {{ form.sacred_or_secular }}
    </div>

    <div>
    <h3> Medium of Performance </h3>
        <p>
            Please enter the instruments or voices below.
        </p>
        {{ form.instruments.label_tag }}
        {{ form.instruments }}
    </div>
    <button type="submit" value="Submit" class="btn btn-primary">Submit</button>
</form>

<style>
    .btn{
        margin-right: 1%;
        margin-bottom: 2%;
    }
    #id_title{
        margin-bottom:2%;
    }
    #section_title-div, #variant_title-div{
        margin-bottom: 1%;
    }
    .input,#id_form-0-person_range_date_birth_0,#id_form-0-person_range_date_death_0,#id_form-0-date_0{
        margin-right: 1%;
    }
    #genre_type_autocomplete_add{
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: space-between;
    }
    #add-type-input{
        padding-bottom: 5px;
        min-height: 32px;
        display: block;
        padding: .375rem .75rem;
        height: fit-content;
        margin-right: 5%;
        margin-left: 5%;
    }
    #add-type{
        display: flex;
        flex-direction: row;
        align-items: baseline;
        justify-content: flex-end;
        padding-bottom: 5px;
    }
</style>

<script>
    $('#add_more').click(function() {
        var form_idx = $('#id_form-TOTAL_FORMS').val();
        $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
        $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1);
    });

    $(document).on('click', '.delete-form', function() {
        var form_idx = parseInt($('#id_form-TOTAL_FORMS').val());
        $(this).parent().remove();
        $('#id_form-TOTAL_FORMS').val(form_idx - 1);
    });
    $(document).ready(function() {
        $('.autocomplete-select2').select2();
    });

</script>
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener to the button
      var addButton = document.getElementById('add-type-button');
      addButton.addEventListener('click', function() {
        var newTypeName = document.getElementById('add-type-input').value;
  
        // Send AJAX request to the server
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "{% url 'create-type-function' %}", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              // Handle success response
              console.log("New type created successfully!");
            } else {
              // Handle error response
              console.log("Error creating new type:", xhr.responseText);
            }
          }
        };
        xhr.send('typeName=' + encodeURIComponent(newTypeName));
        xhr.send('newObjectForAutocomplete=' + encodeURIComponent('True'));
      });
    });
  </script>


{% endblock %}