{% extends "database/base.html" %}
{% load static %}
{% block content %}

<head>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
</head>
{{ form.media }}
{% if error_message %}
    <div class="alert alert-warning" role="alert">{{ error_message }}</div>
{% endif %}
<form method="post">
    {% csrf_token %}
    <h2> Create a Musical Work </h2>
    <br>
    <h3> Title </h3>
    <div id='work_form'>
    <p>
        What is the title of the work? 
        Click the green button to add variant titles or nicknames.
        Please include opus number or catalogue numbers if applicable (e.g., 
        Op. 55, D960, BWV 202).
    </p>
        {{ form.title.label_tag }}
        {{ form.title }}
        <div class="multiple-entry"> 
            {{ form.variant_titles.label_tag }}
            {{ form.variant_titles }}
        </div>
        <div class="multiple-entry"> 
            {{ form.sections.label_tag }}
            <div id="select-div-parent" style="display: flex; flex-direction: column;">
                <div id="select-div">
                    {{ form.select_section }}
                    {{ form.sections }}
                </div>
            </div>
            <div style="display: flex; flex-direction: row;">
                <input class="btn btn-success btn-sm" type="button" value="+" onclick="addSectionField()">
                <input class="btn btn-danger btn-sm" type="button" value="-" onclick="deleteSectionField()">
            </div>
        </div>
    <br>
    <h3> Contributions </h3>
    {{ contribution_form.management_form }}
        <div id="form_set">
            <p>
                Who created the work? 
                Use the drop-down menu to choose between different kinds of 
                contributions. Add more contributors with the green 
                button. 
            </p>
            {% for form in contribution_form %}
                <div class="contribution-form">
                    <div class="contribution-form-field">
                        {{ form.person_given_name.label_tag }}
                        {{ form.person_given_name }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.person_surname.label_tag }}
                        {{ form.person_surname }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.person_range_date_birth.label_tag }}
                        {{ form.person_range_date_birth }}
                        {{ form.birth_info }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.person_range_date_death.label_tag }}
                        {{ form.person_range_date_death }}
                        {{ form.death_info }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.role.label_tag }}
                        {{ form.role }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.certainty_of_attribution.label_tag }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.certainty_of_attribution }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.location.label_tag }}
                        {{ form.location }}
                    </div>
                    <div class="contribution-form-field">
                        {{ form.date.label_tag }}
                        {{ form.date }}
                    </div>
                </div>
            {% endfor %}
            <div id="empty_form" style="display: none;">
                <div class="contributor-form">
                    <button class="btn btn-danger delete-form">-</button>
                    <div class="contribution-form">
                        <div class="contribution-form-field">
                            {{ form.person_given_name.label_tag }}
                            {{ form.person_given_name }}
                        </div>
                        <div class="contribution-form-field">
                            {{ form.person_surname.label_tag }}
                            {{ form.person_surname }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.person_range_date_birth.label_tag }}
                            {{ contribution_form.empty_form.person_range_date_birth }}
                            {{ contribution_form.empty_form.birth_info }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.person_range_date_death.label_tag }}
                            {{ contribution_form.empty_form.person_range_date_death }}
                            {{ contribution_form.empty_form.death_info }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.role.label_tag }}
                            {{ contribution_form.empty_form.role }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.certainty_of_attribution.label_tag }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.certainty_of_attribution }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.location.label_tag }}
                            {{ contribution_form.empty_form.location }}
                        </div>
                        <div class="contribution-form-field">
                            {{ contribution_form.empty_form.date.label_tag }}
                            {{ contribution_form.empty_form.date }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    <input input class="btn btn-success" type="button" id="add_more" value="+">
    <br><br>
    <h3> Genre(s) </h3>
        <p>
            What type of piece is this? (e.g., song, symphony, motet)
        </p>
        <div class="genre_autocomplete_add">
            {{ form.genre_as_in_type }}
            <div class="add-genre">
                <input type="text" class="add-more-input" id="add-type-input"/>
                <button class="btn btn-success btn-sm add-more-button" id="add-type-button">Add New Type</button>
            </div>
        </div>
        <p>
            What style is this piece? (e.g., classical, jazz)
        </p>
        <div class="genre_autocomplete_add">
            {{ form.genre_as_in_style }}
            <div class="add-genre">
                <input type="text" class="add-more-input" id="add-style-input"/>
                <button class="btn btn-success btn-sm add-more-button" id="add-style-button">Add New Style</button>
            </div>
        </div>

        {{ form.sacred_or_secular.label_tag }}
        {{ form.sacred_or_secular }}
    </div>

    <div>
    <br>
    <h3> Medium of Performance </h3>
        <p>
            Please enter the instruments or voices below.
        </p>
        {{ form.instruments.label_tag }}
        <div class="genre_autocomplete_add">
            {{ form.instruments }}
            <div class="add-genre">
                <input type="text" class="add-more-input" id="add-instrument-input"/>
                <button class="btn btn-success btn-sm add-more-button" id="add-instrument-button">Add New Instrument</button>
            </div>
        </div>
    </div>
    <br><br>
    <button type="submit" value="Submit" class="btn-block btn btn-lg btn-primary">Submit</button>
    <br>
</form>

<script>

    $('.select2-selection__rendered').select2({
        dropdownParent: $('.select2-selection--single')
    });

    $('#add_more').click(function() {
        var form_idx = $('#id_form-TOTAL_FORMS').val();
        $('#form_set').append($('#empty_form').html().replace(/__prefix__/g, form_idx));
        $('#id_form-TOTAL_FORMS').val(parseInt(form_idx) + 1);
        // $('.autocomplete-select2').select2();
    });

    $(document).on('click', '.delete-form', function() {
        var form_idx = parseInt($('#id_form-TOTAL_FORMS').val());
        $(this).parent().remove();
        $('#id_form-TOTAL_FORMS').val(form_idx - 1);
    });
    $(document).ready(function() {
        // $('.autocomplete-select2').select2();
    });

    var sectionDivCount = 1; 

    function addSectionField() {
        var div = document.getElementById("select-div");
        var div_parent = document.getElementById("select-div-parent");
        var div_clone = div.cloneNode(false);
        var sections = document.getElementById("id_sections");
        var select_section = document.getElementById("id_select_section");
        var select_section_clone = select_section.cloneNode(true);
        select_section_clone.id = "id_select_section" + i;
        select_section_clone.id = "id_select_section" + i;
        select_section_clone.value = "";
        div_clone.appendChild(select_section_clone);
        var sections_clone = sections.cloneNode(true);
        sections_clone.id = "id_sections" + i;
        sections_clone.id = "id_sections" + i;
        sections_clone.value = "";
        div_clone.appendChild(sections_clone);

        div_parent.appendChild(div_clone);

        i++;
    }
    function deleteSectionField() {
        if (i === 1){
            return
        }
        document.getElementById("id_sections" + (i - 1)).remove();
        document.getElementById("id_select_section" + (i - 1)).remove();
        i--;
    }


    document.addEventListener('DOMContentLoaded', function() {
      // Listen for add Genre Type
      var addButton = document.getElementById('add-type-button');
      addButton.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent form submission
        var newTypeName = document.getElementById('add-type-input').value;
        // Send AJAX request to the server
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "{% url 'create-type-function' %}", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              console.log("New type created successfully!");
            } else {
              console.log("Error creating new type:", xhr.responseText);
            }
          }
        };
        xhr.send('typeName=' + encodeURIComponent(newTypeName));
        xhr.send('newObjectForAutocomplete=' + encodeURIComponent('True'));
      });
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Listen for add Genre Type
      var addButton = document.getElementById('add-style-button');
      addButton.addEventListener('click', function(event) {
        event.preventDefault();
        var newStyleName = document.getElementById('add-style-input').value;
        // Send AJAX request to the server
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "{% url 'create-style-function' %}", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              console.log("New style created successfully!");
            } else {
              console.log("Error creating new style:", xhr.responseText);
            }
          }
        };
        xhr.send('styleName=' + encodeURIComponent(newStyleName));
        xhr.send('newObjectForAutocomplete=' + encodeURIComponent('True'));
      });
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Listen for add instrument
      var addButton = document.getElementById('add-instrument-button');
      addButton.addEventListener('click', function(event) {
        event.preventDefault();
        var newInstrumentName = document.getElementById('add-instrument-input').value;
        // Send AJAX request to the server
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "{% url 'create-instrument-function' %}", true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onreadystatechange = function() {
          if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
              console.log("New instrument created successfully!");
            } else {
              console.log("Error creating new instrument:", xhr.responseText);
            }
          }
        };
        xhr.send('instrumentName=' + encodeURIComponent(newInstrumentName));
        xhr.send('newObjectForAutocomplete=' + encodeURIComponent('True'));
      });
    });


  </script>


<style>
    .contribution-form-field{
        margin-bottom: 1.5vh;
        display: flex;
        flex-direction: row;
        align-items: center;
    }        
    .btn{   
        margin-right: 1%;
        margin-bottom: 2%;
    }

    #id_title{
        margin-bottom:2%;
    }
    #section_title-div, #variant_title-div{
        margin-bottom: 1%;
    }
    [id^="id_form-"][id$="-person_range_date_birth_0"],
    [id^="id_form-"][id$="-person_range_date_death_0"],
    [id^="id_form-"][id$="date_0"],
    .input,#id_form-0-date_0{
        margin-right: 1%;
    }
    .genre_autocomplete_add{
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: space-between;
    }
    .add-more-input{
        padding-bottom: 5px;
        min-height: 32px;
        display: block;
        padding: .375rem .75rem;
        height: fit-content;
        margin-right: 5%;
        margin-left: 5%;
    }
    .add-genre{
        display: flex;
        flex-direction: row;
        align-items: baseline;
        justify-content: flex-end;
        padding-bottom: 5px;
    }
    .select2-selection {
        min-height: 4vh !important;
    }
    .selection{
        width: 60vh; /* overrides default which is in px */
    }
    .errorlist {
        font-size: smaller;
        font-style: italic;
        color: darkred;
    }
    #select-div {
        margin-bottom: 1%;
        display: flex;
        flex-direction: row;
    }
    [id^="id_select_section"]{
        margin-right: 1%;
        width: 25%
    }
    .info-tooltip-widget {
        margin-left: 1%;
    }
    #add-type-input,#add-style-input,#add-instrument-input,
    [id^="id_form"]:not([id$="certainty_of_attribution"],.info-tooltip-widget) {
        padding: .375rem .75rem;
        font-size: 1rem;
        line-height: 1.5;
        color: #495057;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: .25rem;
        transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
    }
    span.select2-selection.select2-selection--single.form-control.autocomplete-select2 {
        min-height: 4vh !important;
    }

    /* bootstrap class not showing */
    .form-select {
        display: inline-block;
        position: relative;
        padding: .375rem .75rem;
        line-height: 1.5;
        color: #495057;
        vertical-align: middle;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-select:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .form-select[multiple],
    .form-select[size]:not([size="1"]) {
        height: auto;
        padding-right: 0.75rem;
        background-image: none;
    }
    .contribution-form label {
        margin-bottom: 0;
        margin-right: 1%;
    }
    [id$="-certainty_of_attribution"] {
        width: 50vh;
        margin-left: 1%;
    }

</style>

{% endblock %}